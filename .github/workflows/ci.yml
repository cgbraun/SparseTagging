name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r requirements-dev.txt

      - name: Lint with ruff
        continue-on-error: true
        run: |
          ruff check src/ tests/ > ruff-lint.txt 2>&1 || true
          echo "Exit code: $?" >> ruff-lint.txt

      - name: Check formatting with ruff
        continue-on-error: true
        run: |
          ruff format --check src/ tests/ > ruff-format.txt 2>&1 || true
          echo "Exit code: $?" >> ruff-format.txt

      - name: Type check with mypy
        continue-on-error: true
        run: |
          mypy src/sparsetag.py src/cache_manager.py src/exceptions.py > mypy-report.txt 2>&1 || true
          echo "Exit code: $?" >> mypy-report.txt

      - name: Upload quality reports
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # v4.5.0
        if: always()
        with:
          name: quality-reports
          path: |
            ruff-lint.txt
            ruff-format.txt
            mypy-report.txt
          retention-days: 90

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: quality
    environment: CGB
    permissions:
      contents: read
      pull-requests: read
    env:
      GITHUB_TOKEN: ${{ github.token }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r requirements-dev.txt

      - name: Run tests with coverage
        run: |
          pytest tests/ --cov=src --cov-report=xml --cov-report=term-missing -v

      - name: Verify SONAR_TOKEN is available
        shell: bash
        run: |
          if [ -z "${SONAR_TOKEN}" ]; then
            echo "::error::SONAR_TOKEN is empty. Check environment attachment, secret name, and fork PR restrictions."
            exit 1
          fi
          echo "SONAR_TOKEN is set (masked)."

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@ffc3010689be73b8e5ae0c57ce35968afd7909e8

      - name: Upload coverage report
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # v4.5.0
        if: always()
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 90

  test:
    name: Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r requirements-dev.txt

      - name: Test with pytest
        continue-on-error: true
        run: |
          pytest tests/ --cov=src --cov-report=xml --cov-report=term-missing --cov-fail-under=85 -v --junitxml=pytest-results.xml > pytest-output.txt 2>&1
          echo "Exit code: $?" >> pytest-output.txt

      - name: Upload test results
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # v4.5.0
        if: always()
        with:
          name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            pytest-output.txt
            pytest-results.xml
            coverage.xml
          retention-days: 90

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238  # v4
        continue-on-error: true  # Don't fail CI if CodeCov upload fails
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.xml
          fail_ci_if_error: false
          verbose: true

  docker-build-scan:
    name: Docker Build & Scan
    runs-on: ubuntu-latest
    needs: [quality, test]
    permissions:
      contents: write  # Changed from 'read' to allow committing scan results
      packages: write
      security-events: write
      actions: read  # Required for SARIF upload

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # Ensure we can push back to repo

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@988b5a0280414f521da01fcc63a27aeeb4b104db  # v3.7.1

      - name: Build Docker image
        uses: docker/build-push-action@48aba3b46d1b1fec4febb7c5d0c644b249a11355  # v6.10.0
        with:
          context: .
          push: false
          load: true
          tags: sparsetagging:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner (SARIF)
        uses: aquasecurity/trivy-action@18f2510ee396bbf400402947b394f2dd8c87dbb0  # master
        continue-on-error: true  # Don't fail if vulnerabilities found, we want the SARIF file
        with:
          image-ref: sparsetagging:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln,secret,config'  # Scan for vulnerabilities, secrets, and misconfigs
          exit-code: '0'  # Don't exit on findings, just create the report

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@ea9e4e37992a54ee68a9622e985e60c8e8f12d9f  # v3.27.6
        if: always()
        continue-on-error: true  # Will fail until Code Scanning is enabled in repo settings
        with:
          sarif_file: 'trivy-results.sarif'
          # To enable: Settings â†’ Code security â†’ Enable Code scanning

      - name: Upload Trivy SARIF report as artifact
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # v4.5.0
        if: always()
        with:
          name: trivy-sarif-report
          path: trivy-results.sarif
          retention-days: 90

      - name: Run Trivy for full report (informational)
        uses: aquasecurity/trivy-action@18f2510ee396bbf400402947b394f2dd8c87dbb0  # master
        continue-on-error: true  # Don't fail build on vulnerabilities (base image issues)
        with:
          image-ref: sparsetagging:${{ github.sha }}
          format: 'table'
          output: 'trivy-report.txt'  # Save table report to file
          exit-code: '0'  # Report vulnerabilities but don't fail the build
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'vuln,secret,config'  # Comprehensive scanning

      - name: Upload Trivy table report as artifact
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # v4.5.0
        if: always()
        with:
          name: trivy-vulnerability-report
          path: trivy-report.txt
          retention-days: 90

      - name: Generate SBOM
        uses: aquasecurity/trivy-action@18f2510ee396bbf400402947b394f2dd8c87dbb0  # master
        with:
          image-ref: sparsetagging:${{ github.sha }}
          format: 'spdx-json'
          output: 'sbom.spdx.json'

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # v4.5.0
        if: always()
        with:
          name: sbom
          path: sbom.spdx.json
          retention-days: 90

      - name: Export Docker image as tarball
        run: |
          docker save sparsetagging:${{ github.sha }} -o sparsetagging-${{ github.sha }}.tar
          gzip sparsetagging-${{ github.sha }}.tar

      - name: Upload Docker image as artifact
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # v4.5.0
        with:
          name: docker-image
          path: sparsetagging-${{ github.sha }}.tar.gz
          retention-days: 30  # Shorter retention for large files

      - name: Generate artifact summary
        run: |
          cat > artifact-summary.md << 'EOF'
          # SparseTagging Docker Build Artifacts

          **Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Commit SHA:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}

          ## Available Artifacts

          ### 1. Docker Image (`docker-image`)
          - **File:** `sparsetagging-${{ github.sha }}.tar.gz`
          - **Size:** ~300MB (compressed)
          - **Usage:**
            ```bash
            # Download and load the image
            gunzip sparsetagging-${{ github.sha }}.tar.gz
            docker load -i sparsetagging-${{ github.sha }}.tar

            # Run the image
            docker run --rm sparsetagging:${{ github.sha }}

            # Interactive shell
            docker run --rm -it sparsetagging:${{ github.sha }} /bin/bash
            ```

          ### 2. Trivy Vulnerability Report (`trivy-vulnerability-report`)
          - **File:** `trivy-report.txt`
          - **Format:** Human-readable table
          - **Severities:** CRITICAL, HIGH, MEDIUM
          - **Scans:** Vulnerabilities, Secrets, Misconfigurations
          - **Usage:** Open in text editor to review findings

          ### 3. Trivy SARIF Report (`trivy-sarif-report`)
          - **File:** `trivy-results.sarif`
          - **Format:** SARIF (machine-readable)
          - **Usage:** Import into security tools, IDEs, or GitHub Security

          ### 4. SBOM - Software Bill of Materials (`sbom`)
          - **File:** `sbom.spdx.json`
          - **Format:** SPDX JSON
          - **Usage:** Compliance, license tracking, supply chain security
            ```bash
            # View with Trivy
            trivy sbom sbom.spdx.json

            # Validate SPDX
            java -jar spdx-tools.jar Verify sbom.spdx.json
            ```

          ## Image Details

          - **Base Image:** python:3.11-slim
          - **Architecture:** linux/amd64
          - **User:** sparsetag (UID 1000, non-root)
          - **Working Directory:** /app
          - **Python Version:** 3.11
          - **SparseTagging Version:** 2.4.1

          ## Testing the Image

          ```bash
          # Load the image
          docker load -i sparsetagging-${{ github.sha }}.tar

          # Verify it works
          docker run --rm sparsetagging:${{ github.sha }} python -c "import sparsetagging; print('OK')"

          # Run benchmarks (if available)
          docker run --rm sparsetagging:${{ github.sha }} python -m pytest --version
          ```

          ## Security Review

          1. **Review vulnerabilities:** Check `trivy-report.txt`
          2. **Check SARIF:** Import `trivy-results.sarif` to IDE
          3. **Verify SBOM:** Review `sbom.spdx.json` for dependencies
          4. **Test image:** Load and run security scans locally

          ## GitHub Container Registry

          On main branch, this image is also published to:
          ```
          ghcr.io/cgbraun/sparsetagging:latest
          ghcr.io/cgbraun/sparsetagging:2.4.1
          ```

          Pull and use:
          ```bash
          docker pull ghcr.io/cgbraun/sparsetagging:latest
          docker run --rm ghcr.io/cgbraun/sparsetagging:latest
          ```
          EOF

      - name: Upload artifact summary
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # v4.5.0
        if: always()
        with:
          name: artifact-summary
          path: artifact-summary.md
          retention-days: 90

      - name: Download quality reports
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        if: github.ref == 'refs/heads/main'
        continue-on-error: true
        with:
          name: quality-reports
          path: ./quality-reports/

      - name: Download coverage report
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        if: github.ref == 'refs/heads/main'
        continue-on-error: true
        with:
          name: coverage-report
          path: ./coverage-report/

      - name: Download all test results
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        if: github.ref == 'refs/heads/main'
        continue-on-error: true
        with:
          pattern: test-results-*
          path: ./test-results/
          merge-multiple: false

      - name: Save security artifacts to repository (main branch only)
        if: github.ref == 'refs/heads/main'
        run: |
          # Create timestamped directory
          TIMESTAMP=$(date -u +"%Y-%m-%d_%H-%M-%S")
          SCAN_DIR="ScanResults/${TIMESTAMP}"
          mkdir -p "${SCAN_DIR}"

          # Copy security artifacts
          cp trivy-results.sarif "${SCAN_DIR}/" 2>/dev/null || echo "âš ï¸ trivy-results.sarif not found"
          cp trivy-report.txt "${SCAN_DIR}/" 2>/dev/null || echo "âš ï¸ trivy-report.txt not found"
          cp sbom.spdx.json "${SCAN_DIR}/" 2>/dev/null || echo "âš ï¸ sbom.spdx.json not found"

          # Copy code quality reports
          cp quality-reports/ruff-lint.txt "${SCAN_DIR}/" 2>/dev/null || echo "âš ï¸ ruff-lint.txt not found"
          cp quality-reports/ruff-format.txt "${SCAN_DIR}/" 2>/dev/null || echo "âš ï¸ ruff-format.txt not found"
          cp quality-reports/mypy-report.txt "${SCAN_DIR}/" 2>/dev/null || echo "âš ï¸ mypy-report.txt not found"
          cp coverage-report/coverage.xml "${SCAN_DIR}/" 2>/dev/null || echo "âš ï¸ coverage.xml not found"

          # Create test summary from all test matrix results
          cat > "${SCAN_DIR}/test-summary.md" << TEST_SUMMARY
          # Test Results Summary

          **Test Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Test Matrix:** Python 3.10, 3.11, 3.12, 3.13 Ã— Ubuntu + Windows

          ---

          ## Test Results by Environment

          TEST_SUMMARY

          # Parse test results from each matrix run
          if [ -d "test-results" ]; then
            for test_dir in test-results/test-results-*; do
              if [ -d "$test_dir" ]; then
                os_py=$(basename "$test_dir" | sed 's/test-results-//')
                echo "" >> "${SCAN_DIR}/test-summary.md"
                echo "### $os_py" >> "${SCAN_DIR}/test-summary.md"
                echo "" >> "${SCAN_DIR}/test-summary.md"

                if [ -f "$test_dir/pytest-output.txt" ]; then
                  # Extract key metrics
                  if grep -q "passed" "$test_dir/pytest-output.txt"; then
                    grep -E "(passed|failed|error|skipped|warnings summary)" "$test_dir/pytest-output.txt" | tail -5 >> "${SCAN_DIR}/test-summary.md"
                  else
                    echo "âš ï¸ Test output not parseable" >> "${SCAN_DIR}/test-summary.md"
                  fi
                  echo "" >> "${SCAN_DIR}/test-summary.md"
                fi
              fi
            done
          fi

          cat >> "${SCAN_DIR}/test-summary.md" << 'TEST_FOOTER'

          ---

          ## Full Test Outputs

          Individual test outputs for each environment are available in the \`test-results/\` directory.

          TEST_FOOTER

          # Generate SonarCloud link file
          cat > "${SCAN_DIR}/sonarcloud-links.md" << SONAR_EOF
          # SonarCloud Analysis Results

          **Project:** SparseTagging
          **Commit:** \${{ github.sha }}
          **Branch:** \${{ github.ref_name }}
          **Scan Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Links

          - **Project Dashboard:** https://sonarcloud.io/project/overview?id=vonbraun_SparseTagging
          - **This Commit:** https://sonarcloud.io/project/overview?id=vonbraun_SparseTagging&branch=\${{ github.ref_name }}
          - **Code Coverage:** https://sonarcloud.io/component_measures?id=vonbraun_SparseTagging&metric=coverage
          - **Security Hotspots:** https://sonarcloud.io/project/security_hotspots?id=vonbraun_SparseTagging
          - **Issues:** https://sonarcloud.io/project/issues?id=vonbraun_SparseTagging

          ## Quick Stats

          View the SonarCloud dashboard for:
          - Code coverage percentage
          - Security vulnerabilities (A-E rating)
          - Code smells and technical debt
          - Duplicated code percentage
          - Reliability and maintainability ratings
          SONAR_EOF

          # Parse vulnerability counts from Trivy report (if it exists)
          CRITICAL_COUNT=0
          HIGH_COUNT=0
          MEDIUM_COUNT=0
          LOW_COUNT=0

          if [ -f "${SCAN_DIR}/trivy-report.txt" ]; then
            # Try to extract counts from Trivy table format (this is a best-effort parse)
            CRITICAL_COUNT=$(grep -c "CRITICAL" "${SCAN_DIR}/trivy-report.txt" 2>/dev/null || echo "0")
            HIGH_COUNT=$(grep -c "HIGH" "${SCAN_DIR}/trivy-report.txt" 2>/dev/null || echo "0")
            MEDIUM_COUNT=$(grep -c "MEDIUM" "${SCAN_DIR}/trivy-report.txt" 2>/dev/null || echo "0")
            LOW_COUNT=$(grep -c "LOW" "${SCAN_DIR}/trivy-report.txt" 2>/dev/null || echo "0")
          fi

          # Generate README.md summary
          cat > "${SCAN_DIR}/README.md" << README_EOF
          # Security Scan Results

          **Scan Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Commit SHA:** \${{ github.sha }}
          **Branch:** \${{ github.ref_name }}
          **Workflow Run:** https://github.com/\${{ github.repository }}/actions/runs/\${{ github.run_id }}

          ---

          ## Vulnerability Summary (Trivy)

          | Severity | Count |
          |----------|-------|
          | CRITICAL | ${CRITICAL_COUNT} |
          | HIGH     | ${HIGH_COUNT} |
          | MEDIUM   | ${MEDIUM_COUNT} |
          | LOW      | ${LOW_COUNT} |

          > **Note:** Counts are approximate based on keyword matching. See `trivy-report.txt` for full details.

          ---

          ## Available Files

          ### 1. `trivy-results.sarif`
          - **Format:** SARIF (Static Analysis Results Interchange Format)
          - **Purpose:** Machine-readable security findings
          - **Usage:**
            - Import into VS Code, PyCharm, or other IDEs with SARIF support
            - Upload to GitHub Security tab (Code Scanning)
            - Process with automated security tools
          - **Contains:** Vulnerabilities, secrets, misconfigurations
          - **Severity Filter:** CRITICAL, HIGH only

          ### 2. `trivy-report.txt`
          - **Format:** Human-readable table
          - **Purpose:** Quick visual review of all vulnerabilities
          - **Usage:** Open in text editor to review findings
          - **Contains:** Vulnerabilities, secrets, misconfigurations
          - **Severity Filter:** CRITICAL, HIGH, MEDIUM

          ### 3. `sbom.spdx.json`
          - **Format:** SPDX 2.3 JSON
          - **Purpose:** Software Bill of Materials for compliance and supply chain security
          - **Usage:**
            ```bash
            # View with Trivy
            trivy sbom sbom.spdx.json

            # Validate SPDX format
            # (requires spdx-tools: https://github.com/spdx/tools)
            java -jar spdx-tools.jar Verify sbom.spdx.json
            ```
          - **Contains:** All packages, versions, licenses, dependencies

          ### 4. `sonarcloud-links.md`
          - **Format:** Markdown with links
          - **Purpose:** Quick access to SonarCloud analysis results
          - **Contains:** Links to dashboards, coverage, security hotspots

          ### 5. `coverage.xml`
          - **Format:** Cobertura XML
          - **Purpose:** Code coverage metrics from pytest
          - **Usage:** Import into IDEs, coverage visualization tools
          - **Contains:** Line-by-line coverage data for all source files

          ### 6. `test-summary.md`
          - **Format:** Markdown summary report
          - **Purpose:** Consolidated test results from all Python versions and platforms
          - **Contains:** Pass/fail status for Python 3.10-3.13 on Ubuntu and Windows

          ### 7. `ruff-lint.txt`
          - **Format:** Plain text
          - **Purpose:** Linting results from ruff
          - **Contains:** Code style violations, unused imports, complexity issues

          ### 8. `ruff-format.txt`
          - **Format:** Plain text
          - **Purpose:** Code formatting check results
          - **Contains:** Files that need formatting, formatting violations

          ### 9. `mypy-report.txt`
          - **Format:** Plain text
          - **Purpose:** Static type checking results
          - **Contains:** Type errors, missing annotations, type mismatches

          ---

          ## How to Use These Results

          ### Quick Security & Quality Review

          1. **Security:** Check `trivy-report.txt` for CRITICAL/HIGH vulnerabilities
          2. **Tests:** Review `test-summary.md` for test pass/fail status
          3. **Code Quality:** Check `ruff-lint.txt` and `mypy-report.txt` for issues
          4. **Coverage:** Review `coverage.xml` metrics (should be â‰¥85%)
          5. **SBOM:** Review `sbom.spdx.json` for dependencies
          6. **SonarCloud:** Click links in `sonarcloud-links.md` for detailed analysis

          ### Detailed Analysis

          1. **Import SARIF to IDE:**
             - VS Code: Install "SARIF Viewer" extension
             - PyCharm: Settings â†’ Tools â†’ SARIF â†’ Import `trivy-results.sarif`

          2. **GitHub Security Tab:**
             - Go to repository Security tab â†’ Code Scanning
             - Results from SARIF upload appear here

          3. **Compare with Previous Scans:**
             - Check `ScanResults/` directory for historical scans
             - Compare vulnerability counts over time

          ---

          ## Docker Image Details

          - **Base Image:** python:3.11-slim (Debian)
          - **Application:** SparseTagging v2.4.1
          - **Python Version:** 3.11
          - **User:** sparsetag (non-root, UID 1000)
          - **Architecture:** linux/amd64

          ---

          ## Next Steps

          If vulnerabilities are found:

          1. **Assess Impact:** Check if the CVE affects SparseTagging's use case
          2. **Check for Fixes:** See if updated base images or packages are available
          3. **Risk Assessment:** Document in SECURITY.md if no fix is available
          4. **Patch:** Update Dockerfile or requirements.txt as needed
          5. **Retest:** Push changes to trigger new security scan

          For questions about these results, see `SECURITY.md` in the repository root.
          README_EOF

          echo "âœ… Security artifacts saved to ${SCAN_DIR}/"
          ls -lah "${SCAN_DIR}/"

      - name: Commit and push security scan results (main branch only)
        if: github.ref == 'refs/heads/main'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          TIMESTAMP=$(date -u +"%Y-%m-%d_%H-%M-%S")

          git add ScanResults/

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(security): add scan results for ${TIMESTAMP}

          - Trivy vulnerability scan (SARIF and table formats)
          - SBOM in SPDX format
          - SonarCloud analysis links
          - Automated scan from commit ${{ github.sha }}

          ðŸ¤– Generated by GitHub Actions"

            git push
          fi

      - name: Log in to GitHub Container Registry
        if: github.ref == 'refs/heads/main'
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567  # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push to GHCR (main branch only)
        if: github.ref == 'refs/heads/main'
        run: |
          docker tag sparsetagging:${{ github.sha }} ghcr.io/${{ github.repository_owner }}/sparsetagging:latest
          docker tag sparsetagging:${{ github.sha }} ghcr.io/${{ github.repository_owner }}/sparsetagging:2.4.1
          docker push ghcr.io/${{ github.repository_owner }}/sparsetagging:latest
          docker push ghcr.io/${{ github.repository_owner }}/sparsetagging:2.4.1
