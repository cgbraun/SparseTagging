name: CVE Tracker

on:
  schedule:
    # Run monthly on the 1st at 9:00 AM UTC
    - cron: '0 9 1 * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-glibc-cve:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check CVE-2026-0861 status on Debian Security Tracker
        id: check_cve
        run: |
          echo "Checking Debian Security Tracker for CVE-2026-0861..."

          # Fetch the CVE page from Debian Security Tracker
          curl -s https://security-tracker.debian.org/tracker/CVE-2026-0861 > cve_page.html

          # Check if page was fetched successfully
          if [ ! -s cve_page.html ]; then
            echo "::warning::Failed to fetch CVE page from Debian Security Tracker"
            echo "status=error" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Look for indicators that the CVE is fixed
          # Debian tracker shows "fixed" when a patch is available
          if grep -qi "fixed in" cve_page.html || grep -qi "not vulnerable" cve_page.html; then
            echo "status=fixed" >> $GITHUB_OUTPUT
            echo "‚úÖ CVE-2026-0861 appears to be FIXED in Debian!"

            # Extract version info if available
            FIXED_VERSION=$(grep -oP 'fixed in \K[0-9.-]+' cve_page.html | head -1 || echo "unknown")
            echo "fixed_version=${FIXED_VERSION}" >> $GITHUB_OUTPUT
            echo "Fixed in version: ${FIXED_VERSION}"
          else
            echo "status=unfixed" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è CVE-2026-0861 still unfixed in Debian"
          fi

          # Save page for debugging
          echo "Page content preview:"
          head -20 cve_page.html

      - name: Comment on issue if CVE is fixed
        if: steps.check_cve.outputs.status == 'fixed'
        uses: actions/github-script@v7
        with:
          script: |
            const fixedVersion = '${{ steps.check_cve.outputs.fixed_version }}';
            const issueNumber = 18;  // CVE-2026-0861 tracking issue

            const comment = `## üéâ CVE-2026-0861 May Be Fixed!

            The automated CVE tracker detected that CVE-2026-0861 may have been patched in Debian.

            **Detected Fix Version:** ${fixedVersion}

            ### Next Steps

            1. **Verify fix is in \`python:3.11-slim\` base image:**
               \`\`\`bash
               docker pull python:3.11-slim
               docker run --rm python:3.11-slim dpkg -l | grep libc6
               \`\`\`

            2. **Rebuild Docker image locally:**
               \`\`\`bash
               docker build -t sparsetagging:test .
               \`\`\`

            3. **Run Trivy scan to verify CVE is resolved:**
               \`\`\`bash
               trivy image sparsetagging:test --severity HIGH,CRITICAL
               \`\`\`

            4. **If verified fixed:**
               - Update SECURITY.md (remove CVE-2026-0861 from accepted risks)
               - Update Dockerfile (remove security comment lines 33-38)
               - Commit changes
               - Close this issue

            ### References

            - **Debian Security Tracker:** https://security-tracker.debian.org/tracker/CVE-2026-0861
            - **Workflow Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - **Detection Date:** ${new Date().toISOString().split('T')[0]}

            ---

            **Note:** This is an automated notification. Please verify manually before taking action.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });

            console.log(`‚úÖ Posted notification to issue #${issueNumber}`);

      - name: Report check status
        if: steps.check_cve.outputs.status == 'unfixed'
        run: |
          echo "‚ÑπÔ∏è CVE-2026-0861 remains unfixed. No action needed."
          echo "Next automatic check: First day of next month at 9:00 AM UTC"

      - name: Report error
        if: steps.check_cve.outputs.status == 'error'
        run: |
          echo "::warning::Failed to check CVE status. This may be due to network issues or changes to the Debian Security Tracker website."
          echo "Please check manually: https://security-tracker.debian.org/tracker/CVE-2026-0861"
