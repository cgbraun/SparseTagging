name: CVE Tracker

on:
  schedule:
    # Run monthly on the 1st at 9:00 AM UTC
    - cron: '0 9 1 * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-glibc-cve:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check CVE-2026-0861 status on Debian Security Tracker
        id: check_cve
        run: |
          echo "Checking Debian Security Tracker for CVE-2026-0861..."

          # Fetch the CVE page from Debian Security Tracker
          curl -s https://security-tracker.debian.org/tracker/CVE-2026-0861 > cve_page.html

          # Check if page was fetched successfully
          if [ ! -s cve_page.html ]; then
            echo "::warning::Failed to fetch CVE page from Debian Security Tracker"
            echo "status=error" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Look for indicators that the CVE is fixed
          # Debian tracker shows "fixed" when a patch is available
          if grep -qi "fixed in" cve_page.html || grep -qi "not vulnerable" cve_page.html; then
            echo "status=fixed" >> $GITHUB_OUTPUT
            echo "‚úÖ CVE-2026-0861 appears to be FIXED in Debian!"

            # Extract version info if available
            FIXED_VERSION=$(grep -oP 'fixed in \K[0-9.-]+' cve_page.html | head -1 || echo "unknown")
            echo "fixed_version=${FIXED_VERSION}" >> $GITHUB_OUTPUT
            echo "Fixed in version: ${FIXED_VERSION}"
          else
            echo "status=unfixed" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è CVE-2026-0861 still unfixed in Debian"
          fi

          # Save page for debugging
          echo "Page content preview:"
          head -20 cve_page.html

      - name: Comment on issue if CVE is fixed
        if: steps.check_cve.outputs.status == 'fixed'
        uses: actions/github-script@v7
        with:
          script: |
            const fixedVersion = '${{ steps.check_cve.outputs.fixed_version }}';
            const issueNumber = 18;  // CVE-2026-0861 tracking issue

            const comment = `## üéâ CVE-2026-0861 May Be Fixed!

            The automated CVE tracker detected that CVE-2026-0861 may have been patched in Debian.

            **Detected Fix Version:** ${fixedVersion}

            ### Next Steps

            1. **Verify fix is in \`python:3.11-slim\` base image:**
               \`\`\`bash
               docker pull python:3.11-slim
               docker run --rm python:3.11-slim dpkg -l | grep libc6
               \`\`\`

            2. **Rebuild Docker image locally:**
               \`\`\`bash
               docker build -t sparsetagging:test .
               \`\`\`

            3. **Run Trivy scan to verify CVE is resolved:**
               \`\`\`bash
               trivy image sparsetagging:test --severity HIGH,CRITICAL
               \`\`\`

            4. **If verified fixed:**
               - Update SECURITY.md (remove CVE-2026-0861 from accepted risks)
               - Update Dockerfile (remove security comment lines 33-38)
               - Commit changes
               - Close this issue

            ### References

            - **Debian Security Tracker:** https://security-tracker.debian.org/tracker/CVE-2026-0861
            - **Workflow Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - **Detection Date:** ${new Date().toISOString().split('T')[0]}

            ---

            **Note:** This is an automated notification. Please verify manually before taking action.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });

            console.log(`‚úÖ Posted notification to issue #${issueNumber}`);

      - name: Report check status
        if: steps.check_cve.outputs.status == 'unfixed'
        run: |
          echo "‚ÑπÔ∏è CVE-2026-0861 remains unfixed. No action needed."
          echo "Next automatic check: First day of next month at 9:00 AM UTC"

      - name: Report error
        if: steps.check_cve.outputs.status == 'error'
        run: |
          echo "::warning::Failed to check CVE status. This may be due to network issues or changes to the Debian Security Tracker website."
          echo "Please check manually: https://security-tracker.debian.org/tracker/CVE-2026-0861"

  check-jaraco-context-cve:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check GHSA-58pv-8j8x-9vj2 status in setuptools
        id: check_jaraco
        run: |
          echo "Checking setuptools releases for jaraco.context >=6.1.0..."

          # Fetch latest setuptools releases from PyPI
          curl -s https://pypi.org/pypi/setuptools/json > setuptools.json

          # Check if page was fetched successfully
          if [ ! -s setuptools.json ]; then
            echo "::warning::Failed to fetch setuptools info from PyPI"
            echo "status=error" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get the latest version
          LATEST_VERSION=$(jq -r '.info.version' setuptools.json)
          echo "Latest setuptools version: ${LATEST_VERSION}"

          # Check setuptools GitHub releases page for vendored jaraco.context info
          # Note: This is a heuristic check - setuptools doesn't always document vendored updates
          curl -s "https://api.github.com/repos/pypa/setuptools/releases?per_page=10" > releases.json

          # Look for mentions of jaraco.context 6.1.0 or higher in recent releases
          if grep -qi "jaraco.context.*6\.[1-9]" releases.json || grep -qi "jaraco.context.*[7-9]\." releases.json; then
            echo "status=potentially_fixed" >> $GITHUB_OUTPUT
            echo "‚úÖ setuptools may have updated jaraco.context!"
            echo "latest_version=${LATEST_VERSION}" >> $GITHUB_OUTPUT
          else
            echo "status=unfixed" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è GHSA-58pv-8j8x-9vj2 still present - setuptools vendored jaraco.context not yet updated"
          fi

          # Save for debugging
          echo "Recent release notes preview:"
          jq -r '.[0].body' releases.json | head -30 || echo "No release notes found"

      - name: Comment on issue if potentially fixed
        if: steps.check_jaraco.outputs.status == 'potentially_fixed'
        uses: actions/github-script@v7
        with:
          script: |
            const latestVersion = '${{ steps.check_jaraco.outputs.latest_version }}';
            const issueNumber = 19;  // GHSA-58pv-8j8x-9vj2 tracking issue

            const comment = `## üéâ GHSA-58pv-8j8x-9vj2 May Be Fixed!

            The automated CVE tracker detected that setuptools may have updated its vendored jaraco.context dependency.

            **Latest setuptools version:** ${latestVersion}

            ### Next Steps

            1. **Verify jaraco.context version in setuptools:**
               \`\`\`bash
               # Install latest setuptools in clean environment
               python -m venv test_env
               source test_env/bin/activate  # or test_env\\Scripts\\activate on Windows
               pip install setuptools==${latestVersion}

               # Check vendored jaraco.context version
               find test_env -name "jaraco.context*.dist-info" -exec basename {} \\;
               \`\`\`

            2. **If jaraco.context >=6.1.0 found, rebuild Docker image:**
               \`\`\`bash
               docker build -t sparsetagging:test .
               \`\`\`

            3. **Run Trivy scan to verify GHSA-58pv-8j8x-9vj2 is resolved:**
               \`\`\`bash
               trivy image sparsetagging:test --severity HIGH,CRITICAL
               \`\`\`

            4. **If verified fixed:**
               - Update SECURITY.md (remove GHSA-58pv-8j8x-9vj2 from accepted risks)
               - Update Dockerfile builder stage comment if needed
               - Commit changes
               - Close this issue

            ### References

            - **setuptools Releases:** https://github.com/pypa/setuptools/releases
            - **PyPI:** https://pypi.org/project/setuptools/
            - **Workflow Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - **Detection Date:** ${new Date().toISOString().split('T')[0]}

            ---

            **Note:** This is an automated notification based on release notes. Please verify manually that vendored jaraco.context is actually updated.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });

            console.log(`‚úÖ Posted notification to issue #${issueNumber}`);

      - name: Report check status
        if: steps.check_jaraco.outputs.status == 'unfixed'
        run: |
          echo "‚ÑπÔ∏è GHSA-58pv-8j8x-9vj2 remains unfixed. No action needed."
          echo "Next automatic check: First day of next month at 9:00 AM UTC"

      - name: Report error
        if: steps.check_jaraco.outputs.status == 'error'
        run: |
          echo "::warning::Failed to check setuptools status. This may be due to network issues or API changes."
          echo "Please check manually: https://github.com/pypa/setuptools/releases"
